
import pickle
import sys
import dask
import dask.dataframe as dd
import pandas as pd
from sklearn.metrics import accuracy_score, roc_curve, auc
import matplotlib.pyplot as plt
import dill


def main():
    model_file = sys.argv[1]
    test_file = sys.argv[2]
    f = open(model_file, "rb")
    #MalwareDetectionModel = dill.load(f)
    detectionModel = dill.load(f)
    f.close()

    #globals()[MalwareDetectionModel.__name__] = MalwareDetectionModel

    test_with_labels = pd.read_csv(test_file,dtype=detectionModel.dtypes)
    test = test_with_labels.drop('HasDetections', axis=1)
    predictions = detectionModel.predict_probablities(test)

    submission = pd.DataFrame({"MachineIdentifier":test_with_labels['MachineIdentifier'], "HasDetections_actual":test_with_labels['HasDetections']})
    submission["HasDetections_predicted"] = predictions
    fpr, tpr, threshols = roc_curve(submission['HasDetections_actual'], predictions, pos_label=1, drop_intermediate=False)

    roc_auc = auc(fpr, tpr)

    print("AUC: %.2f" % roc_auc)

    plt.plot(fpr, tpr, '-r', label="roc")
    plt.title("malware")
    plt.xlabel('fpr')
    plt.ylabel('tpr')
    plt.legend(loc='upper left')
    plt.grid()
    plt.show()

    return

if __name__ == "__main__":
    main()
